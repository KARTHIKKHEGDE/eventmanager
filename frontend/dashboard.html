<!DOCTYPE html>
<html lang="en">
<head>
    <title>Event Finance Manager - Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <script src="config.js"></script>
    <style>
        .stat-card {
            position: relative;
            overflow: hidden;
        }
        .stat-card::after {
            content: '';
            position: absolute;
            top: -50%; right: -50%;
            width: 200px; height: 200px;
            background: radial-gradient(circle, rgba(255,255,255,0.2), transparent);
            border-radius: 50%;
            transform: scale(0);
            transition: transform 0.5s ease;
        }
        .stat-card:hover::after {
            transform: scale(1);
        }
        
        .alert-item {
            background: rgba(245, 158, 11, 0.1); 
            border-left: 4px solid var(--warning);
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: fadeIn 0.3s ease forwards;
        }
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar animate-fade-in">
        <div class="brand-logo">
            <span>üî∑</span> EventFi
        </div>
        <div class="nav-links">
            <a href="index.html" class="nav-link">Home</a>
        </div>
    </nav>

    <div class="container animate-fade-in delay-100">

        <div class="flex-between mb-4">
            <h1 style="font-size: 2.25rem;">Dashboard</h1>

            <!-- Event Selector -->
            <div style="display: flex; gap: 10px; width: 400px;">
                <input id="eventId" class="form-control" placeholder="Paste Event ID to Load...">
                <button id="btnLoadEvent" onclick="loadDashboard()" class="btn btn-primary">Load</button>
            </div>
        </div>

        <!-- Stats Grid (Budget Summary) -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            <div class="card stat-card text-center">
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 0.5rem;">TOTAL BUDGET</p>
                <h3 style="color: var(--primary); font-size: 2.5rem;">‚Çπ<span id="budget">0</span></h3>
            </div>
            <div class="card stat-card text-center">
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 0.5rem;">TOTAL SPENT</p>
                <h3 style="color: var(--danger); font-size: 2.5rem;">‚Çπ<span id="spent">0</span></h3>
            </div>
            <div class="card stat-card text-center">
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 0.5rem;">REMAINING</p>
                <h3 style="color: var(--success); font-size: 2.5rem;">‚Çπ<span id="remaining">0</span></h3>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div style="display: grid; grid-template-columns: 1fr; gap: 2rem;">

            <!-- Alerts Section -->
            <div class="card" id="alertsCard" style="display: none; border-left: 4px solid var(--warning);">
                <div class="card-title" style="color: var(--warning); display: flex; align-items: center; gap: 0.5rem;">
                    <span>‚ö°</span> AI Analysis & Anomalies
                </div>
                <div id="alerts"></div>
            </div>

            <!-- Expenses Table -->
            <div class="card">
                <div class="flex-between mb-4">
                    <div class="card-title">Expense Report</div>
                    <button onclick="toggleEventsList()" class="btn btn-outline" style="font-size: 0.875rem;">View All Events</button>
                </div>

                <!-- Hidden Events List -->
                <div id="eventsListContainer" class="hidden mb-4" style="background: rgba(99, 102, 241, 0.03); padding: 1.5rem; border-radius: var(--radius-md); border: 1px solid var(--border);">
                    <ul id="eventsList" style="list-style: none; padding: 0;"></ul>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Amount</th>
                                <th>Receipt Verification</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="expenseTable">
                            <tr>
                                <td colspan="4" class="text-center" style="padding: 3rem; color: var(--text-muted);">
                                    Enter an Event ID above to visualize data.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <script>
        const BASE_URL = API_BASE_URL;

        function setLoading(btnId, isLoading) {
            const btn = document.getElementById(btnId);
            if (!btn) return;
            if (isLoading) {
                btn.classList.add("loading");
            } else {
                btn.classList.remove("loading");
            }
        }

        async function loadDashboard() {
            const eventId = document.getElementById("eventId").value;
            const btnId = "btnLoadEvent";

            if (!eventId) return;

            setLoading(btnId, true);

            try {
                // Event data
                const eventRes = await fetch(`${BASE_URL}/events`);
                const events = await eventRes.json();
                const event = events.find(e => e._id === eventId); // Client side find for now

                if (!event) {
                    alert("Invalid Event ID");
                    return;
                }

                document.getElementById("budget").innerText = event.totalBudget.toLocaleString();

                // Expenses
                const expRes = await fetch(`${BASE_URL}/expenses/${eventId}`);
                const expenses = await expRes.json();

                let spent = 0;
                const table = document.getElementById("expenseTable");
                table.innerHTML = "";

                if (expenses.length === 0) {
                    table.innerHTML = `<tr><td colspan="4" class="text-center" style="padding: 2rem;">No expenses recorded yet.</td></tr>`;
                }

                expenses.forEach(e => {
                    spent += e.amount;
                    table.innerHTML += `
          <tr>
            <td style="font-weight: 500;">
                <span class="badge badge-primary" style="margin-right: 8px;">${e.category}</span>
            </td>
            <td style="font-weight: 600;">‚Çπ${e.amount.toLocaleString()}</td>
            <td>${e.receiptUrl ? 
                `<a href="${e.receiptUrl}" target="_blank" style="color: var(--primary); font-weight: 500; display: inline-flex; align-items: center; gap: 4px;">
                    üìÑ View Receipt
                 </a>` 
                : `<span style="color: var(--danger); font-size: 0.9rem;">‚ö† Missing</span>`}
            </td>
            <td>
                <button onclick="deleteExpense('${e._id}')" style="color: var(--danger); background: none; border: none; font-weight: 600; cursor: pointer; opacity: 0.8; transition: opacity 0.2s;">
                    Delete
                </button>
            </td>
          </tr>
        `;
                });

                document.getElementById("spent").innerText = spent.toLocaleString();
                document.getElementById("remaining").innerText = (event.totalBudget - spent).toLocaleString();

                // Fraud check
                const alertBox = document.getElementById("alerts");
                const alertCard = document.getElementById("alertsCard");
                alertCard.style.display = "block";
                alertBox.innerHTML = '<p style="color: var(--text-muted); padding: 1rem;">‚è≥ Creating financial analysis...</p>';

                const fraudRes = await fetch(`${BASE_URL}/events/check/${eventId}`);
                const fraud = await fraudRes.json();

                alertBox.innerHTML = "";

                if (fraud.alerts.length === 0) {
                    alertBox.innerHTML = `
                        <div style="background: rgba(16, 185, 129, 0.1); color: var(--success); padding: 1rem; border-radius: 8px; font-weight: 500;">
                             ‚úî Integrity Check Passed. No anomalies detected.
                        </div>`;
                } else {
                    fraud.alerts.forEach(a => {
                        alertBox.innerHTML += `<div class="alert-item">‚ö† ${a}</div>`;
                    });
                }
            } catch (err) {
                console.error(err);
                alert("Error loading dashboard data. Make sure backend is running.");
            } finally {
                setLoading(btnId, false);
            }
        }

        async function deleteExpense(id) {
            if (!confirm("Are you sure you want to delete this expense?")) return;
            await fetch(`${BASE_URL}/expenses/delete/${id}`, { method: "DELETE" });
            loadDashboard();
        }

        let eventsLoaded = false;
        async function toggleEventsList() {
            const container = document.getElementById("eventsListContainer");
            if (container.classList.contains("hidden")) {
                container.classList.remove("hidden");
                if (!eventsLoaded) {
                    await loadAllEvents();
                    eventsLoaded = true;
                }
            } else {
                container.classList.add("hidden");
            }
        }

        async function loadAllEvents() {
            const list = document.getElementById("eventsList");
            list.innerHTML = "Loading...";

            try {
                const res = await fetch(`${BASE_URL}/events`);
                const events = await res.json();
                list.innerHTML = "";

                if (events.length === 0) {
                    list.innerHTML = "<li>No events found.</li>";
                    return;
                }

                events.forEach(e => {
                    const li = document.createElement("li");
                    li.style.padding = "10px";
                    li.style.borderBottom = "1px solid var(--border)";
                    li.style.display = "flex";
                    li.style.justifyContent = "space-between";
                    li.style.alignItems = "center";
                    
                    li.innerHTML = `
            <span>
                <strong style="color: var(--text-main);">${e.name}</strong> 
                <span style="font-family: monospace; background: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 4px; font-size: 0.85rem; color: var(--text-muted); margin-left: 8px;">${e._id}</span>
            </span>
            <button onclick="copyToClipboard('${e._id}')" style="background: none; border: 1px solid var(--primary); color: var(--primary); padding: 4px 10px; border-radius: 12px; cursor: pointer; font-size: 0.8rem;">
                Copy ID
            </button>
          `;
                    list.appendChild(li);
                });
            } catch (err) {
                list.innerHTML = `<li style="color:red;">Error loading events: ${err.message}</li>`;
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert("Event ID copied: " + text);
            });
        }
    </script>

</body>
</html>