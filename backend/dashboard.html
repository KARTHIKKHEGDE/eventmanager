<!DOCTYPE html>
<html lang="en">

<head>
  <title>Event Finance Manager - Dashboard</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>

  <!-- Navbar -->
  <nav class="navbar">
    <div class="brand-logo">
      <span style="font-size: 1.8rem;">üî∑</span> EventFi
    </div>
    <div class="nav-links">
      <a href="index.html" class="nav-link">Home</a>
    </div>
  </nav>

  <div class="container">

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
      <h1 style="font-weight: 800; font-size: 2.5rem; margin: 0;">Event Admin Dashboard</h1>

      <!-- Event Selector -->
      <div style="display: flex; gap: 10px;">
        <input id="eventId" class="form-control" placeholder="Paste Event ID" style="width: 250px;">
        <button onclick="loadDashboard()" class="btn btn-primary">Load Event</button>
      </div>
    </div>

    <!-- Stats Grid (Budget Summary) -->
    <div class="stats-grid card" style="display: flex; justify-content: space-around; padding: 3rem;">
      <div class="stat-item">
        <h3 style="color: var(--primary);">‚Çπ<span id="budget">0</span></h3>
        <p>Total Budget</p>
      </div>
      <div class="stat-item">
        <h3 style="color: #ef4444;">‚Çπ<span id="spent">0</span></h3>
        <p>Total Spent</p>
      </div>
      <div class="stat-item">
        <h3 style="color: #10b981;">‚Çπ<span id="remaining">0</span></h3>
        <p>Remaining Funds</p>
      </div>
    </div>

    <!-- Main Content Grid -->
    <div style="display: grid; grid-template-columns: 1fr; gap: 2rem;">

      <!-- Alerts Section -->
      <div class="card" id="alertsCard" style="display: none;">
        <div class="card-title" style="color: #f59e0b;">‚ö† Analysis & Alerts</div>
        <div id="alerts"></div>
      </div>

      <!-- Expenses Table -->
      <div class="card">
        <div class="flex-row justify-between mb-4">
          <div class="card-title">Expense Report</div>
          <button onclick="toggleEventsList()" class="btn btn-outline" style="font-size: 0.875rem;">See All
            Events</button>
        </div>

        <!-- Hidden Events List -->
        <div id="eventsListContainer" class="hidden mb-4"
          style="background: #f9fafb; padding: 1rem; border-radius: 8px;">
          <ul id="eventsList" style="list-style: none; padding: 0;"></ul>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Category</th>
                <th>Amount</th>
                <th>Receipt</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="expenseTable">
              <tr>
                <td colspan="4" class="text-center" style="color: var(--text-muted); padding: 2rem;">No event loaded.
                  Enter an ID above.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <script>
    const BASE_URL = "https://event-finance-manager.onrender.com";

    async function loadDashboard() {
      const eventId = document.getElementById("eventId").value;
      if (!eventId) return;

      try {
        // Event data
        const eventRes = await fetch(`${BASE_URL}/events`);
        const events = await eventRes.json();
        const event = events.find(e => e._id === eventId);

        if (!event) {
          alert("Invalid Event ID");
          return;
        }

        document.getElementById("budget").innerText = event.totalBudget.toLocaleString();

        // Expenses
        const expRes = await fetch(`${BASE_URL}/expenses/${eventId}`);
        const expenses = await expRes.json();

        let spent = 0;
        const table = document.getElementById("expenseTable");
        table.innerHTML = "";

        if (expenses.length === 0) {
          table.innerHTML = `<tr><td colspan="4" class="text-center">No expenses recorded yet.</td></tr>`;
        }

        expenses.forEach(e => {
          spent += e.amount;
          table.innerHTML += `
          <tr>
            <td style="font-weight: 500;">${e.category}</td>
            <td>‚Çπ${e.amount.toLocaleString()}</td>
            <td>${e.receiptUrl ? `<a href="${e.receiptUrl}" target="_blank" style="color: var(--primary); text-decoration: underline;">View Receipt</a>` : "<span style='color: #ef4444;'>Missing</span>"}</td>
            <td><button onclick="deleteExpense('${e._id}')" style="color: #ef4444; background: none; border: none; font-weight: 600; cursor: pointer;">Delete</button></td>
          </tr>
        `;
        });

        document.getElementById("spent").innerText = spent.toLocaleString();
        document.getElementById("remaining").innerText = (event.totalBudget - spent).toLocaleString();

        // Fraud check
        const alertBox = document.getElementById("alerts");
        const alertCard = document.getElementById("alertsCard");
        alertCard.style.display = "block";
        alertBox.innerHTML = '<p style="color: var(--text-muted);">‚è≥ Analysing financial patterns...</p>';

        const fraudRes = await fetch(`${BASE_URL}/events/check/${eventId}`);
        const fraud = await fraudRes.json();

        alertBox.innerHTML = "";

        if (fraud.alerts.length === 0) {
          alertBox.innerHTML = "<p style='color: #10b981; font-weight: 500;'>‚úî No anomalies or misuse detected.</p>";
        } else {
          fraud.alerts.forEach(a => {
            alertBox.innerHTML += `<div style="padding: 10px; background: #fffbeb; border-left: 4px solid #f59e0b; margin-bottom: 5px; border-radius: 4px;">‚ö† ${a}</div>`;
          });
        }
      } catch (err) {
        console.error(err);
        alert("Error loading dashboard data. Make sure backend is running.");
      }
    }

    async function deleteExpense(id) {
      if (!confirm("Are you sure you want to delete this expense?")) return;
      await fetch(`${BASE_URL}/expenses/delete/${id}`, { method: "DELETE" });
      loadDashboard();
    }

    let eventsLoaded = false;
    async function toggleEventsList() {
      const container = document.getElementById("eventsListContainer");
      if (container.classList.contains("hidden")) {
        container.classList.remove("hidden");
        if (!eventsLoaded) {
          await loadAllEvents();
          eventsLoaded = true;
        }
      } else {
        container.classList.add("hidden");
      }
    }

    async function loadAllEvents() {
      const list = document.getElementById("eventsList");
      list.innerHTML = "Loading...";

      try {
        const res = await fetch(`${BASE_URL}/events`);
        const events = await res.json();
        list.innerHTML = "";

        if (events.length === 0) {
          list.innerHTML = "<li>No events found.</li>";
          return;
        }

        events.forEach(e => {
          const li = document.createElement("li");
          li.style.padding = "8px";
          li.style.borderBottom = "1px solid #e5e7eb";
          li.style.display = "flex";
          li.style.justifyContent = "space-between";

          li.innerHTML = `
            <span><strong>${e.name}</strong> <span style="font-family: monospace; background: #eee; padding: 2px 5px; rounded: 4px; font-size: 0.8rem;">${e._id}</span></span>
            <button onclick="copyToClipboard('${e._id}')" style="background: none; border: none; color: var(--primary); cursor: pointer;">Copy ID</button>
          `;
          list.appendChild(li);
        });
      } catch (err) {
        list.innerHTML = `<li style="color:red;">Error loading events: ${err.message}</li>`;
      }
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        alert("Event ID copied: " + text);
      });
    }
  </script>

</body>

</html>